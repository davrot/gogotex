name: Frontend Unit & Smoke

on:
  push:
    paths:
      - 'frontend/**'
      - 'phases/PHASE-03-frontend-basics.md'
  workflow_dispatch: {}

jobs:
  unit-and-smoke:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Use Node.js 20
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        working-directory: frontend
        run: npm ci --no-audit --no-fund

      - name: Run unit tests (Vitest)
        working-directory: frontend
        run: npm run test:unit --silent

      - name: Build frontend (smoke)
        working-directory: frontend
        run: npm run build --if-present

      - name: Smoke check: bundle contains auth payload
        working-directory: frontend
        run: |
          set -euo pipefail
          js_file=$(ls dist/assets/index-*.js | head -n1 || true)
          if [ -z "$js_file" ]; then echo "ERROR: built asset not found"; exit 1; fi
          if ! grep -E -q '("mode":"auth_code"|mode:"auth_code")' "$js_file"; then
            echo "ERROR: frontend bundle missing mode:\"auth_code\""; exit 2
          fi
