services:

############
# Keycloak #
############
  keycloak-postgres:
    extends:
      file: ./keycloak-service/keycloak-postgres.yaml
      service: keycloak-postgres

  keycloak-keycloak:
    extends:
      file: ./keycloak-service/keycloak.yaml
      service: keycloak-keycloak
    depends_on:
      keycloak-postgres:
        condition: service_healthy
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.keycloak.rule=Host(`keycloak.local`)"
      - "traefik.http.routers.keycloak.entrypoints=web"
      - "traefik.http.services.keycloak.loadbalancer.server.port=8080"

###########
# MONGODB #
###########
  mongodb-mongodb:
    extends:
      file: ./mongodb-service/mongodb.yaml
      service: mongodb-mongodb

  mongodb-express:
    extends:
      file: ./mongodb-service/mongodb-express.yaml
      service: mongodb-express
    depends_on:
      mongodb-mongodb:
        condition: service_healthy

  mongodb-exporter:
    extends:
      file: ./mongodb-service/mongodb-exporter.yaml
      service: mongodb-exporter
    depends_on:
      mongodb-mongodb:
        condition: service_healthy

  mongodb-exporter-healthcheck:
    extends:
      file: ./mongodb-service/mongodb-exporter-healthcheck.yaml
      service: mongodb-exporter-healthcheck
    depends_on:
      - mongodb-exporter

#########
# REDIS #
#########
  redis-redis:
    extends:
      file: ./redis-service/redis.yaml
      service: redis-redis

  redis-commander:
    extends:
      file: ./redis-service/redis-commander.yaml
      service: redis-commander
    depends_on:
      redis-redis:
        condition: service_healthy

  redis-exporter:
    extends:
      file: ./redis-service/redis-exporter.yaml
      service: redis-exporter
    depends_on:
      redis-redis:
        condition: service_healthy

  redis-exporter-healthcheck:
    extends:
      file: ./redis-service/redis-exporter-healthcheck.yaml
      service: redis-exporter-healthcheck
    depends_on:
      - redis-exporter

#########
# MINIO #
#########
  minio-minio:
    extends:
      file: ./minio-service/minio.yaml
      service: minio-minio

###########
# GRAFANA #
###########
  grafana-prometheus:
    extends:
      file: ./grafana-service/prometheus.yaml
      service: grafana-prometheus
    depends_on:
      redis-exporter-healthcheck:
        condition: service_healthy
      mongodb-exporter-healthcheck:
        condition: service_healthy
      minio-minio:
        condition: service_healthy

  grafana-grafana:
    extends:
      file: ./grafana-service/grafana.yaml
      service: grafana-grafana
    depends_on:
      grafana-prometheus:
        condition: service_healthy

#########
# Auth (local dev) #
#########
  gogotex-auth:
    extends:
      file: ./auth-service/auth.yaml
      service: gogotex-auth
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.gogotex-auth.rule=Host(`auth.local`)"
      - "traefik.http.routers.gogotex-auth.entrypoints=web"
      - "traefik.http.services.gogotex-auth.loadbalancer.server.port=8081"

#########
# nginx #
#########
  nginx-nginx:
    extends:
      file: ./nginx-service/nginx.yaml
      service: nginx-nginx
    depends_on:
      gogotex-auth:
        condition: service_healthy
      grafana-grafana:
        condition: service_healthy
      keycloak-keycloak:
        condition: service_healthy
      mongodb-express:
        condition: service_healthy
      redis-commander:
        condition: service_healthy

  traefik:
    image: traefik:v2.10
    container_name: traefik
    command:
      - --configFile=/etc/traefik/traefik.yml
    ports:
      - "127.0.0.1:8082:80"   # Traefik HTTP on host:8082 (does not conflict with nginx)
      - "127.0.0.1:8083:8080" # Traefik dashboard (insecure)
      - "127.0.0.1:8443:443"  # Traefik HTTPS on host:8443 (serves TLS using provided cert)
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - ./traefik/traefik.yml:/etc/traefik/traefik.yml:ro
      - ./traefik/dynamic.yml:/etc/traefik/dynamic.yml:ro
      - ./nginx-service/config-nginx/ssl:/etc/traefik/ssl:ro
    networks:
      - tex-network

networks:
  tex-network:
    external: true

